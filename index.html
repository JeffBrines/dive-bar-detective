<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dive Bar Detective</title>
    
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üïµÔ∏è</text></svg>">
    
    <!-- Open Graph / Social Sharing -->
    <meta property="og:type" content="website">
    <meta property="og:title" content="Dive Bar Detective">
    <meta property="og:description" content="Find the best dive bars in Denver. Discover hidden gems, authentic neighborhood spots, and unpretentious watering holes with our ML-powered scoring system.">
    <meta property="og:image" content="https://divebar.jeffbrines.com/og-image.png">
    <meta property="og:url" content="https://divebar.jeffbrines.com/">
    
    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Dive Bar Detective">
    <meta name="twitter:description" content="Find the best dive bars in Denver. Discover hidden gems and authentic neighborhood spots.">
    <meta name="twitter:image" content="https://divebar.jeffbrines.com/og-image.png">
    
    <!-- General Meta -->
    <meta name="description" content="Find the best dive bars in Denver. Discover hidden gems, authentic neighborhood spots, and unpretentious watering holes with our ML-powered scoring system.">
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
     crossorigin=""/>
    
    <style>
        :root {
            --gem-color: #27ae60;
            --solid-color: #2980b9;
            --meh-color: #95a5a6;
            --bg-color: #f4f4f9;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            padding: 0; /* Remove default padding for full layout */
            color: #333;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        header {
            background: #2c3e50;
            color: white;
            padding: 15px 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        h1 {
            margin: 0;
            font-size: 1.5rem;
        }
        .header-left {
            display: flex;
            flex-direction: column;
            gap: 2px;
            line-height: 1.2;
        }
        .tagline {
            font-size: 0.82rem;
            opacity: 0.9;
            font-weight: 400;
        }
        .header-right {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 6px;
        }
        .byline {
            font-size: 0.75rem;
            opacity: 0.7;
        }
        .byline a {
            color: inherit;
            text-decoration: none;
        }
        .byline a:hover {
            text-decoration: underline;
        }
        .header-actions {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .header-link {
            background: transparent;
            color: #fff;
            border: 1px solid rgba(255,255,255,0.35);
            border-radius: 10px;
            padding: 7px 10px;
            font-size: 0.9rem;
            cursor: pointer;
            white-space: nowrap;
        }
        .header-link:hover { border-color: rgba(255,255,255,0.7); }

        /* About modal */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.45);
            display: none;
            z-index: 2200;
        }
        .modal-overlay.show { display: block; }
        .modal {
            position: fixed;
            top: 72px;
            left: 50%;
            transform: translateX(-50%);
            width: min(720px, 92vw);
            max-height: calc(100vh - 110px);
            overflow-y: auto;
            background: white;
            border-radius: 14px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.25);
            z-index: 2300;
            display: none;
        }
        .modal.show { display: block; }
        .modal-header {
            padding: 14px 16px;
            border-bottom: 1px solid #eee;
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            gap: 10px;
        }
        .modal-title { margin: 0; font-size: 1.05rem; }
        .modal-body { padding: 12px 16px 16px; color: #333; line-height: 1.5; font-size: 0.95rem; }
        .modal-body ul { margin: 8px 0 0 18px; }
        .modal-body li { margin: 6px 0; }
        
        /* Donation button hover effects */
        .modal-body a[href*="stripe"]:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
        }

        /* Small info button */
        .info-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 22px;
            height: 22px;
            border-radius: 999px;
            border: 1px solid #cbd5e1;
            background: #fff;
            color: #111827;
            font-weight: 900;
            font-size: 0.85rem;
            line-height: 1;
            cursor: pointer;
        }
        .info-btn:hover { background: #f3f4f6; }

        /* Layout */
        .main-content {
            display: flex;
            flex: 1;
            overflow: hidden; /* Hide scroll on body */
            height: calc(100vh - 60px); /* Adjust for header */
        }

        /* Sidebar (List & Filters) */
        .sidebar {
            width: 450px;
            background: #f8f9fa;
            border-right: 1px solid #ddd;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .filters-container {
            padding: 15px;
            background: white;
            border-bottom: 1px solid #eee;
        }

        .filters-toggle {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            margin-bottom: 10px;
        }
        .filters-toggle button {
            width: auto;
            padding: 6px 10px;
            font-size: 0.85rem;
            border-radius: 8px;
            background: #2c3e50;
            color: #fff;
            border: 1px solid #2c3e50;
            cursor: pointer;
        }
        .filters-toggle button:hover { background: #34495e; border-color: #34495e; }

        .advanced-filters {
            display: none;
        }
        .advanced-filters.show {
            display: contents; /* keep grid layout without extra wrappers */
        }

        .controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        label {
            font-weight: 600;
            font-size: 0.8rem;
            color: #555;
        }
        
        select, button {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 0.9rem;
            width: 100%;
        }

        .search-btn {
            background-color: #2c3e50;
            color: white;
            border: none;
            cursor: pointer;
            grid-column: span 2;
            font-weight: bold;
            margin-top: 5px;
        }
        .search-btn:hover { background-color: #34495e; }

        .results-list {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
        }

        /* Map Container */
        #map {
            flex: 1;
            height: 100%;
            background: #e5e5e5;
        }

        /* Cards */
        .card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            margin-bottom: 15px;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 5px solid transparent;
            cursor: pointer;
            transition: all 0.2s;
        }
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            background-color: #fafafa;
        }

        .card.focused {
            outline: 2px solid #2c3e50;
            outline-offset: 2px;
            background-color: #f9fafb;
        }
        
        .card.gem { border-left-color: var(--gem-color); }
        .card.solid { border-left-color: var(--solid-color); }
        .card.meh { border-left-color: var(--meh-color); }

        .info h2 { margin: 0 0 5px; font-size: 1.1rem; }
        .meta { color: #666; font-size: 0.85rem; line-height: 1.4; }
        
        .badges { margin-top: 8px; display: flex; gap: 6px; flex-wrap: wrap; }
        .badge { background: #eee; padding: 3px 6px; border-radius: 4px; font-size: 0.75rem; }
        .badge.ml { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .badge.vibe { background: #eef2ff; color: #3730a3; border: 1px solid #c7d2fe; }
        
        .maps-link {
            display: inline-flex;
            align-items: center;
            gap: 3px;
            padding: 3px 8px;
            background: #f0f9ff;
            border: 1px solid #bae6fd;
            border-radius: 6px;
            color: #0369a1;
            font-size: 0.75rem;
            font-weight: 600;
            text-decoration: none;
            margin-left: 6px;
            transition: all 0.15s;
        }
        .maps-link:hover {
            background: #e0f2fe;
            border-color: #7dd3fc;
            color: #0c4a6e;
        }
        
        .score-box { text-align: center; min-width: 70px; }
        .dive-score { font-size: 2.2rem; font-weight: 900; display: block; letter-spacing: 0.02em; }
        .score-sub { font-size: 0.72rem; color: #666; margin-top: 2px; }
        .gem .dive-score { color: var(--gem-color); }
        .solid .dive-score { color: var(--solid-color); }
        .meh .dive-score { color: var(--meh-color); }
        .gem-label { font-size: 0.7rem; font-weight: bold; text-transform: uppercase; }

        .loading { text-align: center; margin-top: 30px; color: #666; }

        /* Mobile Map Floating Filter Bar */
        .mobile-map-filters {
            display: none;
            position: fixed;
            top: 58px;
            left: 10px;
            right: 10px;
            z-index: 500;
        }
        .mobile-map-filters.show { display: block; }
        .mobile-map-filters-toggle {
            display: flex;
            align-items: center;
            gap: 6px;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 8px 12px;
            font-size: 0.85rem;
            font-weight: 600;
            color: #2c3e50;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            cursor: pointer;
            width: auto;
        }
        .mobile-map-filters-icon {
            font-size: 1rem;
        }
        .mobile-map-filters-panel {
            display: none;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            padding: 12px;
            margin-top: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.12);
        }
        .mobile-map-filters-panel.show { display: block; }
        .mobile-map-filter-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        .mobile-map-filter-row label {
            font-size: 0.8rem;
            font-weight: 600;
            color: #555;
            min-width: 65px;
        }
        .mobile-map-filter-row input[type="range"] {
            flex: 1;
            accent-color: #2c3e50;
        }
        .mobile-map-filter-row span {
            font-size: 0.85rem;
            font-weight: 700;
            color: #2c3e50;
            min-width: 32px;
            text-align: right;
        }
        .mobile-map-apply-btn {
            width: 100%;
            background: #2c3e50;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 10px;
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
        }
        .mobile-map-apply-btn:hover { background: #34495e; }

        /* Vibe Map Quick Preview (mobile) */
        .vibe-preview-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.25);
            z-index: 1800;
        }
        .vibe-preview-overlay.show { display: block; }
        .vibe-preview {
            display: none;
            position: fixed;
            bottom: 60px;
            left: 10px;
            right: 10px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            z-index: 1850;
            padding: 14px;
        }
        .vibe-preview.show { display: block; }
        .vibe-preview-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 10px;
            margin-bottom: 12px;
        }
        .vibe-preview-name {
            font-size: 1.1rem;
            font-weight: 700;
            color: #2c3e50;
            text-decoration: none;
            flex: 1;
        }
        .vibe-preview-name:hover { text-decoration: underline; }
        .vibe-preview-close {
            background: transparent;
            border: none;
            font-size: 1.5rem;
            color: #94a3b8;
            cursor: pointer;
            padding: 0;
            line-height: 1;
            width: 28px;
            height: 28px;
        }
        .vibe-preview-scores {
            display: flex;
            justify-content: space-around;
            gap: 10px;
            margin-bottom: 10px;
        }
        .vibe-preview-score {
            text-align: center;
            flex: 1;
        }
        .vibe-preview-label {
            display: block;
            font-size: 0.7rem;
            color: #64748b;
            margin-bottom: 2px;
        }
        .vibe-preview-value {
            display: block;
            font-size: 1.4rem;
            font-weight: 800;
            color: #2c3e50;
        }
        .vibe-preview-hint {
            text-align: center;
            font-size: 0.7rem;
            color: #94a3b8;
        }

        /* Details Panel */
        .overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.35);
            display: none;
            z-index: 2000;
        }
        .overlay.show { display: block; }

        .details-panel {
            position: fixed;
            top: 0;
            right: 0;
            height: 100vh;
            width: min(420px, 92vw);
            background: white;
            z-index: 2100;
            box-shadow: -8px 0 24px rgba(0,0,0,0.15);
            transform: translateX(110%);
            transition: transform 0.2s ease;
            display: flex;
            flex-direction: column;
        }
        .details-panel.show { transform: translateX(0); }

        .details-header {
            padding: 14px 16px;
            border-bottom: 1px solid #eee;
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            gap: 10px;
        }
        .details-title { margin: 0; font-size: 1.1rem; line-height: 1.25; }
        .close-btn {
            background: transparent;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 6px 10px;
            cursor: pointer;
            width: auto;
            color: #111827;
            font-weight: 700;
        }
        .close-btn:hover {
            background: #f3f4f6;
            border-color: #cbd5e1;
        }
        .details-body {
            padding: 14px 16px 18px;
            overflow-y: auto;
        }
        .details-links a {
            display: inline-block;
            margin-right: 10px;
            margin-top: 8px;
            font-size: 0.9rem;
            color: #2c3e50;
            text-decoration: underline;
        }
        .kv {
            margin-top: 10px;
            font-size: 0.9rem;
            color: #444;
            line-height: 1.45;
        }
        .reviews {
            margin-top: 14px;
        }
        .review {
            border: 1px solid #eee;
            border-radius: 10px;
            padding: 10px 12px;
            margin-top: 10px;
            background: #fafafa;
        }
        .review .meta {
            font-size: 0.78rem;
            color: #666;
            margin-bottom: 6px;
        }
        .review .text {
            font-size: 0.9rem;
            color: #333;
            white-space: pre-wrap;
        }

        /* View Toggle (List vs Vibe Map) */
        .view-toggle {
            display: flex;
            gap: 0;
            margin-bottom: 10px;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid #e2e8f0;
        }
        .view-toggle button {
            flex: 1;
            padding: 8px 12px;
            border: none;
            background: #f8fafc;
            color: #64748b;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.15s;
        }
        .view-toggle button:hover {
            background: #f1f5f9;
        }
        .view-toggle button.active {
            background: #2c3e50;
            color: white;
        }
        .view-toggle button:first-child {
            border-right: 1px solid #e2e8f0;
        }
        
        /* Vibe Map Container */
        .vibe-map-container {
            display: none;
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            min-height: 0;
        }
        .vibe-map-container.show {
            display: flex;
            flex-direction: column;
        }
        .vibe-map-chart-wrapper {
            flex: 1;
            min-height: 300px;
            max-height: calc(100vh - 380px);
            position: relative;
        }
        .vibe-map-container canvas {
            width: 100% !important;
            height: 100% !important;
        }
        .vibe-map-header {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            border-radius: 8px;
            padding: 12px 15px;
            margin-bottom: 12px;
        }
        .vibe-map-header h4 {
            margin: 0 0 6px 0;
            font-size: 0.95rem;
            color: #1e293b;
        }
        .vibe-map-header p {
            margin: 0;
            font-size: 0.8rem;
            color: #64748b;
            line-height: 1.4;
        }
        .vibe-map-legend {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 12px;
            padding: 10px 0;
            font-size: 0.75rem;
            color: #64748b;
        }
        .vibe-map-legend span {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .legend-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }

        /* Custom Lens Builder */
        .custom-lens-builder {
            display: none;
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            padding: 14px;
            margin-top: 10px;
            grid-column: span 2;
        }
        .custom-lens-builder.show { display: block; }
        .custom-lens-builder h4 {
            margin: 0 0 12px;
            font-size: 0.9rem;
            color: #1e293b;
        }
        .signal-slider {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }
        .signal-slider label {
            flex: 0 0 130px;
            font-size: 0.78rem;
            font-weight: 500;
            color: #475569;
        }
        .signal-slider input[type="range"] {
            flex: 1;
            accent-color: #2c3e50;
        }
        .signal-slider .weight-value {
            flex: 0 0 40px;
            font-size: 0.8rem;
            font-weight: 700;
            color: #2c3e50;
            text-align: right;
        }
        .custom-lens-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }
        .custom-lens-actions button {
            flex: 1;
            padding: 8px;
            font-size: 0.85rem;
            border-radius: 6px;
            cursor: pointer;
        }
        .apply-custom-btn {
            background: #2c3e50;
            color: white;
            border: none;
        }
        .apply-custom-btn:hover { background: #34495e; }
        .reset-custom-btn {
            background: white;
            color: #2c3e50;
            border: 1px solid #2c3e50;
        }
        .reset-custom-btn:hover { background: #f1f5f9; }

        /* ========================================
           MOBILE RESPONSIVE STYLES
           ======================================== */
        
        /* Mobile Bottom Tab Bar */
        .mobile-tabs {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #fff;
            border-top: 1px solid #e2e8f0;
            z-index: 1500;
            padding: 0;
            padding-bottom: env(safe-area-inset-bottom, 0);
        }
        .mobile-tabs-inner {
            display: flex;
            justify-content: space-around;
            align-items: stretch;
        }
        .mobile-tab {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 8px 4px;
            background: transparent;
            border: none;
            color: #64748b;
            font-size: 0.7rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.15s;
            min-height: 52px;
        }
        .mobile-tab:active {
            background: #f1f5f9;
        }
        .mobile-tab.active {
            color: #2c3e50;
        }
        .mobile-tab-icon {
            font-size: 1.25rem;
            margin-bottom: 2px;
        }
        .mobile-tab.active .mobile-tab-icon {
            transform: scale(1.1);
        }

        /* Mobile Header Menu */
        .mobile-menu-btn {
            display: none;
            background: transparent;
            border: 1px solid rgba(255,255,255,0.35);
            border-radius: 6px;
            color: #fff;
            padding: 0;
            font-size: 1.1rem;
            cursor: pointer;
            width: 40px;
            height: 36px;
            min-width: 40px;
            max-width: 40px;
            flex-shrink: 0;
        }
        .mobile-menu-btn:hover {
            border-color: rgba(255,255,255,0.7);
        }
        .mobile-menu {
            display: none;
            position: fixed;
            top: 50px;
            right: 10px;
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            z-index: 1100;
            min-width: 180px;
            overflow: hidden;
        }
        .mobile-menu.show {
            display: block;
        }
        .mobile-menu-item {
            display: block;
            width: 100%;
            padding: 14px 16px;
            background: transparent;
            border: none;
            text-align: left;
            font-size: 0.95rem;
            color: #333;
            cursor: pointer;
            border-bottom: 1px solid #f1f5f9;
        }
        .mobile-menu-item:last-child {
            border-bottom: none;
        }
        .mobile-menu-item:active {
            background: #f8fafc;
        }
        .mobile-menu-overlay {
            display: none;
            position: fixed;
            inset: 0;
            z-index: 1050;
        }
        .mobile-menu-overlay.show {
            display: block;
        }

        /* Mobile Responsive Breakpoints */
        @media (max-width: 768px) {
            /* Header compact mode */
            header {
                padding: 8px 12px;
            }
            h1 {
                font-size: 1.1rem;
            }
            .tagline {
                font-size: 0.7rem;
            }
            .header-right {
                display: none;
            }
            .mobile-menu-btn {
                display: flex;
                align-items: center;
                justify-content: center;
                width: 40px;
                max-width: 40px;
            }

            /* Main layout - full screen views */
            .main-content {
                flex-direction: column;
                height: calc(100vh - 50px);
                padding-bottom: 52px; /* Space for bottom tabs */
            }
            
            /* Sidebar becomes full-screen */
            .sidebar {
                position: absolute;
                top: 50px;
                left: 0;
                right: 0;
                bottom: 52px;
                width: 100%;
                height: auto;
                z-index: 100;
                display: flex;
                flex-direction: column;
                border-right: none;
            }
            .sidebar.mobile-hidden {
                display: none;
            }
            
            /* Map becomes full-screen */
            #map {
                position: absolute;
                top: 50px;
                left: 0;
                right: 0;
                bottom: 52px;
                height: auto;
                z-index: 99;
            }
            #map.mobile-hidden {
                display: none;
            }

            /* Bottom tabs visible */
            .mobile-tabs {
                display: block;
            }

            /* Hide List/Vibe toggle on mobile - use bottom nav instead */
            .view-toggle {
                display: none !important;
            }

            /* Filters container - more compact */
            .filters-container {
                padding: 10px 12px;
                flex-shrink: 0;
            }

            /* Filters toggle row - compact on mobile */
            .filters-toggle {
                margin-bottom: 6px;
            }
            .filters-toggle > div:first-child {
                display: none; /* Hide "Filters" label on mobile */
            }
            .filters-toggle button {
                padding: 6px 12px;
                font-size: 0.8rem;
                min-height: 32px;
                width: 100%;
            }

            /* Hide Lens and Type on mobile by default - show in More Filters */
            .control-group.mobile-advanced {
                display: none;
            }
            .advanced-filters.show .control-group.mobile-advanced {
                display: flex;
            }

            /* Controls grid - single column on mobile for compactness */
            .controls {
                gap: 6px;
            }
            .control-group {
                gap: 2px;
            }
            
            /* Labels smaller */
            .controls label {
                font-size: 0.75rem;
            }
            
            /* Selects and inputs smaller */
            .controls select {
                padding: 6px 8px;
                font-size: 0.85rem;
            }

            /* Minimum score slider more compact */
            #minLensScoreValue {
                font-size: 0.9rem;
                min-width: 40px;
            }
            
            /* Search button */
            .search-btn {
                padding: 10px;
                font-size: 0.9rem;
                min-height: 40px;
                margin-top: 4px;
            }

            /* Results count smaller */
            #resultsCount {
                font-size: 0.8rem;
                margin-top: 4px;
            }

            /* Results list - maximize scroll area */
            .results-list {
                padding: 10px;
                flex: 1;
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
            }

            /* Cards mobile - more compact */
            .card {
                padding: 10px;
                margin-bottom: 10px;
                flex-direction: row;
                gap: 8px;
            }
            .card .info {
                flex: 1;
                min-width: 0;
            }
            .card .info h2 {
                font-size: 0.95rem;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }
            .card .meta {
                font-size: 0.75rem;
            }
            .card .score-box {
                min-width: 55px;
                flex-shrink: 0;
            }
            .card .dive-score {
                font-size: 1.6rem;
            }
            .card .score-sub {
                font-size: 0.65rem;
            }
            .card .gem-label {
                font-size: 0.6rem;
            }
            .badges {
                gap: 3px;
                margin-top: 6px;
            }
            .badge {
                font-size: 0.65rem;
                padding: 2px 4px;
            }
            .maps-link {
                font-size: 0.65rem;
                padding: 2px 6px;
            }

            /* Vibe map mobile */
            .vibe-map-container {
                padding: 10px;
            }
            .vibe-map-header {
                padding: 8px 10px;
                margin-bottom: 8px;
            }
            .vibe-map-header h4 {
                font-size: 0.85rem;
                margin-bottom: 4px;
            }
            .vibe-map-header p {
                font-size: 0.7rem;
            }
            .vibe-map-chart-wrapper {
                max-height: calc(100vh - 280px);
            }
            .vibe-map-legend {
                gap: 6px;
                font-size: 0.65rem;
                padding: 6px 0;
                flex-wrap: wrap;
            }

            /* Custom lens builder mobile */
            .custom-lens-builder {
                padding: 10px;
            }
            .custom-lens-builder h4 {
                font-size: 0.85rem;
                margin-bottom: 10px;
            }
            .signal-slider {
                gap: 6px;
                margin-bottom: 6px;
            }
            .signal-slider label {
                flex: 0 0 90px;
                font-size: 0.7rem;
            }
            .signal-slider .weight-value {
                flex: 0 0 32px;
                font-size: 0.7rem;
            }
            .custom-lens-actions {
                margin-top: 10px;
            }
            .custom-lens-actions button {
                min-height: 38px;
                font-size: 0.8rem;
            }

            /* Details panel - full screen slide up */
            .details-panel {
                width: 100%;
                height: 85vh;
                top: auto;
                bottom: 0;
                left: 0;
                right: 0;
                border-radius: 16px 16px 0 0;
                transform: translateY(100%);
            }
            .details-panel.show {
                transform: translateY(0);
            }
            .details-header {
                padding: 14px;
            }
            .details-header::before {
                content: '';
                display: block;
                width: 40px;
                height: 4px;
                background: #e2e8f0;
                border-radius: 2px;
                margin: 0 auto 10px;
            }
            .details-body {
                padding: 0 14px 20px;
                padding-bottom: calc(20px + env(safe-area-inset-bottom, 0));
            }
            .close-btn {
                min-height: 40px;
                min-width: 40px;
                padding: 6px 12px;
                font-size: 0.85rem;
            }

            /* Modals mobile */
            .modal {
                top: 10px;
                max-height: calc(100vh - 20px);
                border-radius: 12px;
            }
            .modal-header {
                padding: 12px 14px;
            }
            .modal-body {
                padding: 12px 14px 16px;
            }
            .modal-body input[type="text"],
            .modal-body input[type="email"] {
                padding: 12px !important;
                font-size: 16px !important; /* Prevents iOS zoom */
            }
            .modal-body button[type="submit"] {
                min-height: 48px;
            }

            /* Info button */
            .info-btn {
                width: 28px;
                height: 28px;
                font-size: 0.8rem;
            }
        }

        /* Extra small screens */
        @media (max-width: 380px) {
            h1 {
                font-size: 0.95rem;
            }
            .tagline {
                font-size: 0.65rem;
            }
            .card .info h2 {
                font-size: 0.9rem;
            }
            .card .dive-score {
                font-size: 1.4rem;
            }
            .signal-slider label {
                flex: 0 0 80px;
                font-size: 0.65rem;
            }
            .mobile-tab {
                font-size: 0.65rem;
            }
            .mobile-tab-icon {
                font-size: 1.1rem;
            }
        }
    </style>
    
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
     integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
     crossorigin=""></script>
    <!-- Chart.js for UMAP visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Chart.js zoom plugin -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>
</head>
<body>

    <header>
        <div class="header-left">
            <h1>üïµÔ∏è Dive Bar Detective</h1>
            <div class="tagline">Discover hidden gems the algorithms miss</div>
        </div>
        <div class="header-right">
            <div class="header-actions">
                <button class="header-link" type="button" onclick="openCityRequest()">Request Your City</button>
                <button class="header-link" type="button" onclick="openDonation()">Support</button>
                <button class="header-link" type="button" onclick="openAbout()">About</button>
            </div>
            <div class="byline">by <a href="https://www.jeffbrines.com" target="_blank" rel="noopener">Jeff Brines</a></div>
        </div>
        <button class="mobile-menu-btn" type="button" onclick="toggleMobileMenu()" aria-label="Menu">‚ò∞</button>
    </header>

    <!-- Mobile Menu Dropdown -->
    <div id="mobileMenuOverlay" class="mobile-menu-overlay" onclick="closeMobileMenu()"></div>
    <div id="mobileMenu" class="mobile-menu">
        <button class="mobile-menu-item" type="button" onclick="openCityRequest(); closeMobileMenu();">üìç Request Your City</button>
        <button class="mobile-menu-item" type="button" onclick="openDonation(); closeMobileMenu();">üíú Support</button>
        <button class="mobile-menu-item" type="button" onclick="openAbout(); closeMobileMenu();">‚ÑπÔ∏è About</button>
    </div>

    <!-- City Request modal -->
    <div id="cityRequestOverlay" class="modal-overlay" onclick="closeCityRequest()"></div>
    <section id="cityRequestModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="cityRequestTitle" aria-hidden="true">
        <div class="modal-header">
            <div>
                <h2 id="cityRequestTitle" class="modal-title">Request Your City</h2>
                <div class="meta" style="margin-top:4px;">This project currently only supports Denver</div>
            </div>
            <button class="close-btn" type="button" onclick="closeCityRequest()">Close</button>
        </div>
        <div class="modal-body">
            <div style="font-weight:800; margin-bottom:6px;">Want your city supported?</div>
            <div style="margin-bottom:16px; line-height:1.5;">
                I'd love to expand this to more cities! However, current data acquisition and API costs are higher than I'd like to do this work at scale.
            </div>
            
            <div style="background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; padding: 12px; margin-bottom: 16px;">
                <div style="font-weight:700; margin-bottom:6px; color:#2c3e50;">üí° Good news</div>
                <div style="font-size:0.9rem; line-height:1.5;">
                    I'm actively working on ways to reduce costs. For approximately <b>$30</b>, I can likely add your city to the platform.
                </div>
            </div>
            
            <div style="font-weight:800; margin-bottom:10px;">Interested? Let me know!</div>
            <form id="cityRequestForm" style="display: flex; flex-direction: column; gap: 12px;">
                <div style="display: flex; flex-direction: column; gap: 4px;">
                    <label style="font-weight: 600; font-size: 0.85rem; color: #555;">Your Name</label>
                    <input type="text" id="cityRequestName" required 
                           style="padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 0.9rem;" 
                           placeholder="John Doe">
                </div>
                <div style="display: flex; flex-direction: column; gap: 4px;">
                    <label style="font-weight: 600; font-size: 0.85rem; color: #555;">Your Email</label>
                    <input type="email" id="cityRequestEmail" required 
                           style="padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 0.9rem;" 
                           placeholder="john@example.com">
                </div>
                <div style="display: flex; flex-direction: column; gap: 4px;">
                    <label style="font-weight: 600; font-size: 0.85rem; color: #555;">City You Want Supported</label>
                    <input type="text" id="cityRequestCity" required 
                           style="padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 0.9rem;" 
                           placeholder="Austin, TX">
                </div>
                <button type="submit" 
                        style="background: #2c3e50; color: white; padding: 12px; border: none; border-radius: 8px; font-weight: 700; font-size: 0.95rem; cursor: pointer; margin-top: 8px;">
                    Submit Request
                </button>
            </form>
            
            <div id="cityRequestSuccess" style="display: none; background: #d4edda; border: 1px solid #c3e6cb; color: #155724; padding: 12px; border-radius: 8px; margin-top: 12px; text-align: center; font-weight: 600;">
                ‚úì Request submitted! Check your email for next steps.
            </div>
            
            <div class="meta" style="margin-top:16px; text-align: center; line-height:1.5;">
                Or email me directly at <a href="mailto:jeff.brines@gmail.com" style="color: #2c3e50; font-weight: 600;">jeff.brines@gmail.com</a> to chat about adding your city!
            </div>
        </div>
    </section>

    <!-- Donation modal -->
    <div id="donationOverlay" class="modal-overlay" onclick="closeDonation()"></div>
    <section id="donationModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="donationTitle" aria-hidden="true">
        <div class="modal-header">
            <div>
                <h2 id="donationTitle" class="modal-title">Support This Project</h2>
                <div class="meta" style="margin-top:4px;">Help keep this project running</div>
            </div>
            <button class="close-btn" type="button" onclick="closeDonation()">Close</button>
        </div>
        <div class="modal-body">
            <div style="font-weight:800; margin-bottom:6px;">This project has real costs</div>
            <div style="margin-bottom:14px; line-height:1.5;">
                Running Dive Bar Detective involves ongoing expenses:
            </div>
            <ul style="margin: 8px 0 16px 18px; line-height:1.6;">
                <li><b>OpenAI API</b> ‚Äî Analyzing 4,260+ reviews with LLM</li>
                <li><b>Supabase</b> ‚Äî Database hosting and storage</li>
                <li><b>Google Maps API</b> ‚Äî Place data collection</li>
                <li><b>Outscraper API</b> ‚Äî Review data acquisition (this one kills me)</li>
                <li><b>Compute costs</b> ‚Äî ML feature generation and updates</li>
            </ul>
            
            <div style="font-weight:800; margin-bottom:10px; margin-top:20px;">Buy me a coffee (or beer!) üç∫</div>
            <div style="display: flex; flex-direction: column; gap: 10px;">
                <a href="https://buy.stripe.com/fZu4gs6zh9Ey8k2gcD0Ba00" target="_blank" rel="noopener" 
                   style="display: block; background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); color: white; padding: 14px 20px; border-radius: 10px; text-align: center; text-decoration: none; font-weight: 700; font-size: 1.05rem; transition: transform 0.2s, box-shadow 0.2s;">
                    ‚òï $5 ‚Äî Coffee
                </a>
                <a href="https://buy.stripe.com/6oUeV63n57wq43MgcD0Ba01" target="_blank" rel="noopener"
                   style="display: block; background: linear-gradient(135deg, #f59e0b 0%, #f97316 100%); color: white; padding: 14px 20px; border-radius: 10px; text-align: center; text-decoration: none; font-weight: 700; font-size: 1.05rem; transition: transform 0.2s, box-shadow 0.2s;">
                    üç∫ $10 ‚Äî Beer
                </a>
                <a href="https://buy.stripe.com/aFa5kwbTB7wqeIq7G70Ba02" target="_blank" rel="noopener"
                   style="display: block; background: linear-gradient(135deg, #ec4899 0%, #ef4444 100%); color: white; padding: 14px 20px; border-radius: 10px; text-align: center; text-decoration: none; font-weight: 700; font-size: 1.05rem; transition: transform 0.2s, box-shadow 0.2s;">
                    üçΩÔ∏è $20 ‚Äî Lunch
                </a>
            </div>
            
            <div class="meta" style="margin-top:16px; text-align: center;">
                Your support helps keep this free tool running. Thank you! üôè
            </div>
        </div>
    </section>

    <!-- About modal -->
    <div id="aboutOverlay" class="modal-overlay" onclick="closeAbout()"></div>
    <section id="aboutModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="aboutTitle" aria-hidden="true">
        <div class="modal-header">
            <div>
                <h2 id="aboutTitle" class="modal-title">About Dive Bar Detective</h2>
                <div class="meta" style="margin-top:4px;">A proof-of-concept data science exploration by Jeff Brines.</div>
            </div>
            <button class="close-btn" type="button" onclick="closeAbout()">Close</button>
        </div>
        <div class="modal-body">
            <div style="font-weight:800; margin-bottom:6px;">What this is</div>
            <div>
                A <b>data-driven "Sommelier for Dive Bars"</b> that helps you find off-the-beaten-path spots in your town (or for now, Denver only).
                We use ML, AI and NLP to analyze reviews and extract what matters (at least what matters to Jeff): food quality, vibe, authenticity, and local recommendations.
            </div>

            <div style="font-weight:800; margin-top:12px; margin-bottom:6px;">The dataset</div>
            <div>
                <b>251 locations</b> and <b>4,260+ reviews</b> from Denver bars and restaurants. Being this is a proof of concept, I didn't pull in all locations from Google's Places API, but rather selected a subset of locations that I thought would be interesting and would be a good fit for the project. Overall, I wanted to select a diverse set of locations that would be a good fit for the project. No chains, 
                focused on neighborhood joints with real character. Each review is analyzed to extract 9 quality and vibe signals.</a>.
            </div>

            <div style="font-weight:800; margin-top:12px; margin-bottom:6px;">How scoring works</div>
            <div>
                Scores use <b>percentile-based ranking</b> within our dataset. A score of 9.5 means "top of our curated list" ‚Äî 
                not a perfect 10, but the best relative to other authentic Denver spots. This makes scores comparable across 
                all lenses and helps you quickly identify standouts. And again, the dataset was already limited to only 251 locations, so the scores are not perfect, but they are a good starting point.
            </div>

            <div style="font-weight:800; margin-top:12px; margin-bottom:6px;">The lenses (0‚Äì10)</div>
            <ul>
                <li><b>Quality</b>: "Is it good?" ‚Äî food/drink, recommendations, service, value.</li>
                <li><b>Character</b>: "Has soul?" ‚Äî authenticity, classic, unpretentious, dive-y.</li>
                <li><b>Underrated</b>: "Better than Google says?" ‚Äî our analysis vs star ratings.</li>
                <li><b>Blended</b>: 40% Quality + 35% Character + 25% Underrated.</li>
                <li><b>Custom</b>: Your own weights for all 9 signals.</li>
            </ul>

            <div style="font-weight:800; margin-top:12px; margin-bottom:6px;">Two ways to explore</div>
            <ul>
                <li><b>üìã List</b>: Browse places sorted by your chosen lens. Click any card for details.</li>
                <li><b>üéØ Vibe Map</b>: Scatter plot of Quality (X) vs Character (Y). Top-right = best finds!</li>
            </ul>

            <div style="font-weight:800; margin-top:12px; margin-bottom:6px;">How the Vibe Map works</div>
            <div>
                The Vibe Map visualizes all 251 locations based on their Quality and Character scores. 
                Dashed lines show the median ‚Äî places in the top-right quadrant are above average on both axes.
                Bubble size reflects the current lens score. Scroll to zoom, shift+drag to pan.
            </div>

            <div style="font-weight:800; margin-top:12px; margin-bottom:6px;">Tech behind the scenes</div>
            <div style="font-size:0.9rem; line-height:1.5;">
                <b>NLP Pipeline:</b> LLM-based sentiment analysis and signal extraction from review text.<br>
                <b>UMAP</b> (umap-learn): Dimensionality reduction for clustering similar places.<br>
                <b>scikit-learn:</b> K-Means clustering for vibe tags, Isolation Forest for "Unique" badge detection.<br>
                <b>BERTopic:</b> Auto-tag extraction (e.g., "late-night", "craft-beer") from review topics.<br>
                <b>Transformers:</b> RoBERTa-based sentiment scoring as a secondary signal.
            </div>
        </div>
    </section>

    <!-- Lens info modal -->
    <div id="lensOverlay" class="modal-overlay" onclick="closeLensInfo()"></div>
    <section id="lensModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="lensTitle" aria-hidden="true">
        <div class="modal-header">
            <div>
                <h2 id="lensTitle" class="modal-title">Lens guide</h2>
                <div class="meta" style="margin-top:4px;">How Quality, Character, Underrated, and Blended scores work.</div>
            </div>
            <button class="close-btn" type="button" onclick="closeLensInfo()">Close</button>
        </div>
        <div id="lensBody" class="modal-body"></div>
    </section>

    <div class="main-content">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="filters-container">
                <div class="filters-toggle">
                    <div style="font-weight:700; font-size:0.95rem; color:#2c3e50;">Filters</div>
                    <button id="toggleAdvancedBtn" type="button" onclick="toggleAdvancedFilters()">More filters</button>
                </div>
                <div class="controls">
                    <!-- Minimum score - always visible -->
                    <div class="control-group" style="grid-column: span 2;">
                        <label>Minimum score</label>
                        <div style="display:flex; align-items:center; gap:10px;">
                            <input id="minLensScore" type="range" min="0" max="10" step="0.1" value="0"
                                   style="flex:1; accent-color:#2c3e50;"
                                   oninput="onMinScoreChanged()" />
                            <div id="minLensScoreValue" style="min-width:40px; text-align:right; font-weight:800; color:#2c3e50;">0.0</div>
                        </div>
                    </div>
                    
                    <!-- Lens - hidden on mobile, shown in More Filters -->
                    <div class="control-group mobile-advanced">
                        <label>Lens</label>
                        <div style="display:flex; align-items:center; gap:6px;">
                            <select id="lens" onchange="syncLens('main')" style="flex:1;">
                                <option value="blended_0_10" selected>Blended</option>
                                <option value="quality_0_10">Quality</option>
                                <option value="character_0_10">Character</option>
                                <option value="underrated_0_10">Underrated</option>
                                <option value="custom">Custom...</option>
                            </select>
                            <button class="info-btn" type="button" title="What do these lenses mean?" onclick="openLensInfo()">i</button>
                        </div>
                    </div>
                    
                    <!-- Type - hidden on mobile, shown in More Filters -->
                    <div class="control-group mobile-advanced">
                        <label>Type</label>
                        <select id="typeFilter" title="Choose what kind of places to include" onchange="syncTypeFilter('main')">
                            <option value="all" selected>All</option>
                            <option value="bar">Bar</option>
                            <option value="restaurant">Restaurant</option>
                            <option value="both">Both (Bar + Restaurant)</option>
                        </select>
                    </div>
                    
                    <!-- Custom Lens Builder -->
                    <div id="customLensBuilder" class="custom-lens-builder">
                        <h4>üéõÔ∏è Build Your Custom Lens</h4>
                        <div class="signal-slider">
                            <label title="How good is the food/drinks?">Food & Drink</label>
                            <input type="range" id="w_food_drink_quality" min="0" max="100" value="50" oninput="updateWeightDisplay(this)">
                            <span class="weight-value">50%</span>
                        </div>
                        <div class="signal-slider">
                            <label title="Staff friendliness, attentiveness">Service</label>
                            <input type="range" id="w_service_quality" min="0" max="100" value="30" oninput="updateWeightDisplay(this)">
                            <span class="weight-value">30%</span>
                        </div>
                        <div class="signal-slider">
                            <label title="Bang for buck">Value</label>
                            <input type="range" id="w_value_score" min="0" max="100" value="40" oninput="updateWeightDisplay(this)">
                            <span class="weight-value">40%</span>
                        </div>
                        <div class="signal-slider">
                            <label title="Gritty dive bar energy">Divey Vibe</label>
                            <input type="range" id="w_divey_score" min="0" max="100" value="20" oninput="updateWeightDisplay(this)">
                            <span class="weight-value">20%</span>
                        </div>
                        <div class="signal-slider">
                            <label title="Long-running, neighborhood staple">Classic/Institution</label>
                            <input type="range" id="w_classic_institution" min="0" max="100" value="30" oninput="updateWeightDisplay(this)">
                            <span class="weight-value">30%</span>
                        </div>
                        <div class="signal-slider">
                            <label title="Laid-back, no pretense">Unpretentious</label>
                            <input type="range" id="w_unpretentious" min="0" max="100" value="30" oninput="updateWeightDisplay(this)">
                            <span class="weight-value">30%</span>
                        </div>
                        <div class="signal-slider">
                            <label title="Genuine character, not corporate">Authenticity</label>
                            <input type="range" id="w_authenticity" min="0" max="100" value="40" oninput="updateWeightDisplay(this)">
                            <span class="weight-value">40%</span>
                        </div>
                        <div class="signal-slider">
                            <label title="Would reviewer recommend?">Would Recommend</label>
                            <input type="range" id="w_would_recommend" min="0" max="100" value="50" oninput="updateWeightDisplay(this)">
                            <span class="weight-value">50%</span>
                        </div>
                        <div class="signal-slider">
                            <label title="Unique, stands out">Memorable</label>
                            <input type="range" id="w_memorable" min="0" max="100" value="30" oninput="updateWeightDisplay(this)">
                            <span class="weight-value">30%</span>
                        </div>
                        <div class="custom-lens-actions">
                            <button type="button" class="apply-custom-btn" onclick="applyCustomLens()">Apply Custom Lens</button>
                            <button type="button" class="reset-custom-btn" onclick="resetCustomLens()">Reset</button>
                        </div>
                    </div>
                    
                    <div id="advancedFilters" class="advanced-filters">
                        <div class="control-group">
                            <label>Min Google Rating</label>
                            <select id="minRating">
                                <option value="3.0">3.0+</option>
                                <option value="3.5" selected>3.5+</option>
                                <option value="4.0">4.0+</option>
                                <option value="4.5">4.5+</option>
                            </select>
                        </div>
                        <div class="control-group">
                            <label>Min Google Reviews</label>
                            <select id="minReviews">
                                <option value="0" selected>Any</option>
                                <option value="20">20+</option>
                                <option value="50">50+</option>
                                <option value="100">100+</option>
                                <option value="250">250+</option>
                                <option value="500">500+</option>
                            </select>
                        </div>
                    </div>
                    <button class="search-btn" onclick="fetchLocations()">Apply Filters</button>
                    <div id="resultsCount" style="grid-column: span 2; font-size: 0.85rem; color:#555; margin-top:6px;">
                        Showing 0 results
                    </div>
                    <div style="grid-column: span 2; font-size: 0.75rem; color:#94a3b8; margin-top:2px;">
                        Denver only ¬∑ <a href="#" onclick="openCityRequest(); return false;" style="color:#64748b; text-decoration:underline;">Add your city</a>
                    </div>
                </div>
            </div>
            
            <!-- View Toggle -->
            <div class="view-toggle" style="margin: 0 15px 10px 15px;">
                <button id="listViewBtn" class="active" onclick="switchView('list')">üìã List</button>
                <button id="vibeMapBtn" onclick="switchView('vibe')">üéØ Vibe Map</button>
            </div>
            
            <div id="results" class="results-list">
                <div class="loading">Locating targets...</div>
            </div>
            
            <!-- Vibe Map (UMAP Scatter Plot) -->
            <div id="vibeMapContainer" class="vibe-map-container">
                <div class="vibe-map-header">
                    <h4>üéØ Vibe Map ‚Äî Quality vs Character</h4>
                    <p>Dashed lines = median scores (splits places in half). <b>Top-right</b> = above average on both axes.
                    Click dots for details. Scroll to zoom, shift+drag to pan.</p>
                </div>
                <div class="vibe-map-chart-wrapper">
                    <canvas id="vibeMapChart"></canvas>
                </div>
                <div class="vibe-map-legend">
                    <span><span class="legend-dot" style="background: #27ae60;"></span> Gem (8+)</span>
                    <span><span class="legend-dot" style="background: #2980b9;"></span> Solid (6-8)</span>
                    <span><span class="legend-dot" style="background: #95a5a6;"></span> Meh (&lt;6)</span>
                    <span style="color: #cbd5e1;">|</span>
                    <span>Scroll to zoom ‚Ä¢ Shift+drag to pan</span>
                    <span style="color: #cbd5e1;">|</span>
                    <button onclick="resetVibeMapZoom()" style="font-size: 0.7rem; padding: 2px 8px; border: 1px solid #cbd5e1; border-radius: 4px; background: #f8fafc; cursor: pointer;">Reset Zoom</button>
                </div>
            </div>
        </div>

        <!-- Map -->
        <div id="map"></div>
    </div>

    <!-- Mobile Bottom Tabs -->
    <nav class="mobile-tabs" role="tablist">
        <div class="mobile-tabs-inner">
            <button class="mobile-tab active" id="mobileListTab" onclick="switchMobileTab('list')" role="tab" aria-selected="true">
                <span class="mobile-tab-icon">üìã</span>
                <span>List</span>
            </button>
            <button class="mobile-tab" id="mobileVibeTab" onclick="switchMobileTab('vibe')" role="tab" aria-selected="false">
                <span class="mobile-tab-icon">üéØ</span>
                <span>Vibe</span>
            </button>
            <button class="mobile-tab" id="mobileMapTab" onclick="switchMobileTab('map')" role="tab" aria-selected="false">
                <span class="mobile-tab-icon">üó∫Ô∏è</span>
                <span>Map</span>
            </button>
        </div>
    </nav>

    <!-- Mobile Map Floating Filter Bar -->
    <div id="mobileMapFilters" class="mobile-map-filters">
        <button class="mobile-map-filters-toggle" onclick="toggleMobileMapFilters()">
            <span class="mobile-map-filters-icon">‚öôÔ∏è</span>
            <span id="mobileMapFiltersLabel">Filters</span>
        </button>
        <div id="mobileMapFiltersPanel" class="mobile-map-filters-panel">
            <div class="mobile-map-filter-row">
                <label>Min Score</label>
                <input id="mobileMinScore" type="range" min="0" max="10" step="0.1" value="0"
                       oninput="syncMobileMinScore()" />
                <span id="mobileMinScoreValue">0.0</span>
            </div>
            <button class="mobile-map-apply-btn" onclick="applyMobileFilters()">Apply</button>
        </div>
    </div>

    <!-- Mobile Vibe Map Quick Preview -->
    <div id="vibePreviewOverlay" class="vibe-preview-overlay" onclick="closeVibePreview()"></div>
    <div id="vibePreview" class="vibe-preview" aria-hidden="true">
        <div class="vibe-preview-header">
            <a id="vibePreviewName" href="#" class="vibe-preview-name" onclick="openVibePreviewDetails(); return false;">Loading...</a>
            <button class="vibe-preview-close" onclick="closeVibePreview()">&times;</button>
        </div>
        <div class="vibe-preview-scores">
            <div class="vibe-preview-score">
                <span class="vibe-preview-label">Quality</span>
                <span id="vibePreviewQuality" class="vibe-preview-value">--</span>
            </div>
            <div class="vibe-preview-score">
                <span class="vibe-preview-label">Character</span>
                <span id="vibePreviewCharacter" class="vibe-preview-value">--</span>
            </div>
            <div class="vibe-preview-score">
                <span class="vibe-preview-label">Blended</span>
                <span id="vibePreviewBlended" class="vibe-preview-value">--</span>
            </div>
        </div>
        <div class="vibe-preview-hint">Tap name for full details</div>
    </div>

    <!-- Details Panel -->
    <div id="overlay" class="overlay" onclick="closeDetails()"></div>
    <aside id="detailsPanel" class="details-panel" aria-hidden="true">
        <div class="details-header">
            <div>
                <div id="detailsName" class="details-title">Loading‚Ä¶</div>
                <div id="detailsAddress" class="meta"></div>
                <div id="detailsBadges" class="badges"></div>
            </div>
            <button class="close-btn" onclick="closeDetails()">Close</button>
        </div>
        <div class="details-body">
            <div id="detailsLinks" class="details-links"></div>
            <div id="detailsStats" class="kv"></div>

            <div class="reviews">
                <h3 style="margin: 10px 0 0; font-size: 1rem;">Key reviews</h3>
                <div id="detailsReviews" class="loading" style="margin-top: 10px;">Select a place‚Ä¶</div>
            </div>
        </div>
    </aside>

    <script>
        // API Configuration - automatically detects environment
        const API_BASE_URL = (() => {
            // Check if we're running via python -m http.server (separate frontend server)
            if (window.location.port === '5500' || window.location.port === '3000') {
                return 'http://localhost:8000';
            }
            // Production or same-origin deployment: API is on same server
            return window.location.origin;
        })();

        console.log('API Base URL:', API_BASE_URL);

        let map;
        let markers = [];
        let markerByPlaceId = {};
        let selectedPlace = null;
        let lastLocations = [];
        let lastLens = 'blended_0_10';
        let cardByPlaceId = {};
        let placeById = {};
        let emptyStateMessage = null;
        let lastTotalCount = null;

        // Initialize Map
        function initMap() {
            // Default center (Denver)
            map = L.map('map').setView([39.7392, -104.9903], 13);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);
        }

        async function fetchLocations() {
            const lens = document.getElementById('lens').value;
            const minRating = document.getElementById('minRating').value;
            const minReviews = document.getElementById('minReviews').value;
            const typeFilter = document.getElementById('typeFilter').value;
            const kinds = [];
            let kindsMode = 'any';
            if (typeFilter === 'bar') {
                kinds.push('bar');
            } else if (typeFilter === 'restaurant') {
                kinds.push('restaurant');
            } else if (typeFilter === 'both') {
                kinds.push('bar');
                kinds.push('restaurant');
                kindsMode = 'all';
            }
            const container = document.getElementById('results');

            container.innerHTML = '<div class="loading">Updating intel...</div>';

            try {
                const params = new URLSearchParams();
                params.set('sort_by', lens);
                params.set('min_rating', minRating);
                params.set('min_reviews', minReviews);
                if (kinds.length > 0) {
                    params.set('kinds_mode', kindsMode);
                    kinds.forEach(k => params.append('kinds', k));
                }

                const url = `${API_BASE_URL}/locations?${params.toString()}`;
                const response = await fetch(url);
                const locations = await response.json();
                
                const totalHeader = response.headers.get('X-Total-Count');
                const totalNum = totalHeader ? parseInt(totalHeader, 10) : NaN;
                lastTotalCount = Number.isFinite(totalNum) ? totalNum : null;

                emptyStateMessage = null;
                lastLocations = Array.isArray(locations) ? locations : [];
                lastLens = lens;
                renderLocations();

            } catch (error) {
                container.innerHTML = `<div style="text-align:center; color:red">Connection lost. Is backend running?</div>`;
                console.error('Error:', error);
            }
        }

        function getMinScore() {
            const el = document.getElementById('minLensScore');
            const v = parseFloat(el?.value ?? '0');
            return Number.isFinite(v) ? v : 0;
        }

        function onMinScoreChanged() {
            const v = getMinScore();
            document.getElementById('minLensScoreValue').textContent = v.toFixed(1);
            renderLocations();
        }

        function scrollToPlaceInList(placeId) {
            const card = cardByPlaceId[placeId];
            if (!card) return;

            Object.values(cardByPlaceId).forEach(el => el?.classList?.remove('focused'));
            card.classList.add('focused');
            card.scrollIntoView({ behavior: 'smooth', block: 'center' });
            window.setTimeout(() => card.classList.remove('focused'), 1600);
        }

        // Called from Leaflet popup HTML
        window.jumpToPlace = function(placeId) {
            const place = placeById[placeId];
            if (!place) return false;
            // On mobile, switch to list tab first
            if (window.innerWidth <= 768) {
                switchMobileTab('list');
            }
            scrollToPlaceInList(placeId);
            openDetails(place);
            return false;
        };

        function renderLocations() {
            const container = document.getElementById('results');
            const countEl = document.getElementById('resultsCount');
            const lens = document.getElementById('lens').value;
            const minScore = getMinScore();

            container.innerHTML = '';
            clearMarkers();
            markerByPlaceId = {};
            cardByPlaceId = {};
            placeById = {};

            const filtered = (lastLocations || []).filter(p => {
                if (minScore <= 0) return true;
                const s = p && typeof p[lens] === 'number' ? p[lens] : null;
                return (typeof s === 'number') && !Number.isNaN(s) && s >= minScore;
            });

            if (countEl) {
                const total = (typeof lastTotalCount === 'number') ? lastTotalCount : (lastLocations || []).length;
                if (total && total !== filtered.length) {
                    countEl.textContent = `Showing ${filtered.length} of ${total} results`;
                } else {
                    countEl.textContent = `Showing ${filtered.length} result${filtered.length === 1 ? '' : 's'}`;
                }
            }

            if (filtered.length === 0) {
                container.innerHTML = `<div class="loading">${emptyStateMessage || 'No places found.'}</div>`;
                map.setView([39.7392, -104.9903], 13);
                return;
            }

            const bounds = L.latLngBounds();
            filtered.forEach(place => {
                const card = createCard(place, lens);
                container.appendChild(card);
                if (place?.place_id) {
                    cardByPlaceId[place.place_id] = card;
                    placeById[place.place_id] = place;
                }

                if (place.lat && place.lng) {
                    const marker = L.marker([place.lat, place.lng])
                        .addTo(map)
                        .bindPopup(`
                            <b>${place.name}</b><br>
                            ${lensLabel(lens)}: ${formatScore(place[lens])}<br>
                            <a href="#" onclick="return window.jumpToPlace(decodeURIComponent('${encodeURIComponent(place.place_id)}'))">View in list</a>
                        `);

                    markers.push(marker);
                    markerByPlaceId[place.place_id] = marker;
                    bounds.extend([place.lat, place.lng]);

                    card.addEventListener('click', () => {
                        // On mobile, switch to map tab first
                        if (window.innerWidth <= 768) {
                            switchMobileTab('map');
                        }
                        map.flyTo([place.lat, place.lng], 16);
                        marker.openPopup();
                        openDetails(place);
                    });
                }
            });

            if (markers.length > 0) {
                const sw = bounds.getSouthWest();
                const ne = bounds.getNorthEast();
                const latSpan = Math.abs(ne.lat - sw.lat);
                const lngSpan = Math.abs(ne.lng - sw.lng);
                if (latSpan < 0.35 && lngSpan < 0.35) {
                    map.fitBounds(bounds, { padding: [50, 50] });
                } else {
                    map.setView([39.7392, -104.9903], 13);
                }
            }

            // Update vibe map if it's the active view
            if (currentView === 'vibe') {
                renderVibeMap();
            }
        }

        function lensLabel(lens) {
            if (lens === 'diveiness_0_10' || lens === 'character_0_10') return 'Character';
            if (lens === 'underrated_0_10') return 'Underrated';
            if (lens === 'quality_0_10') return 'Quality';
            if (lens === 'custom') return 'Custom';
            return 'Blended';
        }

        function formatScore(x) {
            return (typeof x === 'number' && !Number.isNaN(x)) ? x.toFixed(1) : '?';
        }

        function createCard(place, lens) {
            const card = document.createElement('div');
            if (place?.place_id) card.dataset.placeId = place.place_id;
            
            let scoreClass = 'meh';
            const s = (typeof place[lens] === 'number') ? place[lens] : place.blended_0_10;
            if (typeof s === 'number') {
                if (s >= 8.5) scoreClass = 'gem';
                else if (s >= 7.0) scoreClass = 'solid';
            }
            
            card.className = `card ${scoreClass}`;
            
            const priceStr = place.price_level ? '$'.repeat(place.price_level) : '?';
            const types = place.types ? place.types.slice(0, 2).map(t => t.replace(/_/g, ' ')).join(', ') : 'Place';
            
            // Underrated score badge (0..10)
            let underratedBadge = '';
            if (typeof place.underrated_0_10 === 'number' && place.underrated_0_10 >= 7.0) {
                underratedBadge = `<span class="badge ml" title="Model thinks this is underrated">üìà Underrated</span>`;
            }

            // Auto-tags from topic modeling
            let autoTagsBadges = '';
            if (Array.isArray(place.auto_tags) && place.auto_tags.length > 0) {
                autoTagsBadges = place.auto_tags.slice(0, 3).map(tag => 
                    `<span class="badge vibe" title="Auto-detected topic">${tag}</span>`
                ).join('');
            }
            
            // Unique badge from anomaly detection
            let uniqueBadge = '';
            if (typeof place.anomaly_score === 'number' && place.anomaly_score < -0.1) {
                uniqueBadge = `<span class="badge" style="background:#fef3c7; color:#92400e; border:1px solid #fcd34d;" title="Statistically unique ‚Äî doesn't fit typical patterns">‚ú® Unique</span>`;
            }
            
            // Google Maps link
            const mapsUrl = `https://www.google.com/maps/place/?q=place_id:${encodeURIComponent(place.place_id)}`;
            
            card.innerHTML = `
                <div class="info">
                    <h2>${place.name}</h2>
                    <div class="meta">
                        ${place.address || ''}<br>
                        <div class="badges">
                            <span class="badge">‚òÖ ${place.rating} (${place.user_ratings_total})</span>
                            <a href="${mapsUrl}" target="_blank" rel="noopener" class="maps-link" onclick="event.stopPropagation();" title="Open in Google Maps">üìç Maps</a>
                            ${underratedBadge}
                            ${uniqueBadge}
                            ${autoTagsBadges}
                        </div>
                    </div>
                </div>
                <div class="score-box">
                    <span class="dive-score" title="${lensLabel(lens)} (0‚Äì10)">${formatScore(place[lens])}</span>
                    <div class="score-sub">${lensLabel(lens)}</div>
                    <span class="gem-label">${scoreClass === 'gem' ? 'Top pick' : (scoreClass === 'solid' ? 'Strong' : '')}</span>
                </div>
            `;
            return card;
        }

        function openDetails(place) {
            selectedPlace = place;
            document.getElementById('overlay').classList.add('show');
            document.getElementById('detailsPanel').classList.add('show');
            document.getElementById('detailsPanel').setAttribute('aria-hidden', 'false');

            document.getElementById('detailsName').textContent = place.name || 'Unknown';
            document.getElementById('detailsAddress').textContent = place.address || '';

            const badgesHtml = `
                <span class="badge">‚òÖ ${place.rating ?? '?'} (${place.user_ratings_total ?? '?'})</span>
            `;
            document.getElementById('detailsBadges').innerHTML = badgesHtml;

            // Links
            const googleMapsUrl = `https://www.google.com/maps/place/?q=place_id:${encodeURIComponent(place.place_id)}`;
            let linksHtml = `<a href="${googleMapsUrl}" target="_blank" rel="noopener">Open in Google Maps</a>`;
            if (place.website) {
                linksHtml += `<a href="${place.website}" target="_blank" rel="noopener">Website</a>`;
            }
            document.getElementById('detailsLinks').innerHTML = linksHtml;

            // Quick stats
            const stats = [];
            if (place.formatted_phone_number) stats.push(`Phone: ${place.formatted_phone_number}`);
            if (typeof place.quality_0_10 === 'number') stats.push(`Quality: ${place.quality_0_10.toFixed(1)}/10`);
            if (typeof place.character_0_10 === 'number') stats.push(`Character: ${place.character_0_10.toFixed(1)}/10`);
            if (typeof place.underrated_0_10 === 'number') stats.push(`Underrated: ${place.underrated_0_10.toFixed(1)}/10`);
            if (typeof place.blended_0_10 === 'number') stats.push(`Blended: ${place.blended_0_10.toFixed(1)}/10`);
            if (typeof place.review_count === 'number') stats.push(`Reviews analyzed: ${place.review_count}`);
            if (place.top_keywords && typeof place.top_keywords === 'object') {
                const kws = Object.keys(place.top_keywords).slice(0, 6);
                if (kws.length) stats.push(`Top keywords: ${kws.join(', ')}`);
            }
            document.getElementById('detailsStats').textContent = stats.join(' ‚Ä¢ ');

            // Reviews
            loadKeyReviews(place.place_id);
        }

        function closeDetails() {
            document.getElementById('overlay').classList.remove('show');
            document.getElementById('detailsPanel').classList.remove('show');
            document.getElementById('detailsPanel').setAttribute('aria-hidden', 'true');
        }

        async function loadKeyReviews(placeId) {
            const box = document.getElementById('detailsReviews');
            box.classList.remove('loading');
            box.innerHTML = '<div class="loading">Loading reviews‚Ä¶</div>';
            try {
                const url = `${API_BASE_URL}/locations/${encodeURIComponent(placeId)}/reviews?limit=4`;
                const res = await fetch(url);
                const reviews = await res.json();
                if (!Array.isArray(reviews) || reviews.length === 0) {
                    box.innerHTML = '<div class="loading">No reviews available.</div>';
                    return;
                }
                box.innerHTML = '';
                reviews.forEach(r => {
                    const el = document.createElement('div');
                    el.className = 'review';
                    const stars = r.rating ? `‚òÖ ${r.rating}` : '';
                    const senti = (typeof r.openai_sentiment === 'number') ? `sent ${r.openai_sentiment.toFixed(2)}` : '';
                    const dive = r.openai_is_dive_positive ? 'dive+' : '';
                    const who = r.author_name ? `by ${r.author_name}` : '';
                    el.innerHTML = `
                        <div class="meta">${[stars, senti, dive, who].filter(Boolean).join(' ‚Ä¢ ')}</div>
                        <div class="text">${(r.review_text || '').slice(0, 420)}${(r.review_text && r.review_text.length > 420) ? '‚Ä¶' : ''}</div>
                    `;
                    box.appendChild(el);
                });
            } catch (e) {
                box.innerHTML = '<div class="loading" style="color:#b91c1c">Failed to load reviews.</div>';
            }
        }

        function clearMarkers() {
            markers.forEach(m => map.removeLayer(m));
            markers = [];
        }

        function toggleAdvancedFilters() {
            const box = document.getElementById('advancedFilters');
            const btn = document.getElementById('toggleAdvancedBtn');
            const mobileAdvanced = document.querySelectorAll('.control-group.mobile-advanced');
            const isOpen = box.classList.toggle('show');
            btn.textContent = isOpen ? 'Hide filters' : 'More filters';
            
            // On mobile, also show/hide the inline mobile-advanced fields
            if (window.innerWidth <= 768) {
                mobileAdvanced.forEach(el => {
                    el.style.display = isOpen ? 'flex' : 'none';
                });
            }
            
            // Sync values between main and advanced selects
            const lensAdvanced = document.getElementById('lensAdvanced');
            const typeAdvanced = document.getElementById('typeFilterAdvanced');
            if (lensAdvanced) lensAdvanced.value = document.getElementById('lens').value;
            if (typeAdvanced) typeAdvanced.value = document.getElementById('typeFilter').value;
        }

        function openCityRequest() {
            document.getElementById('cityRequestOverlay').classList.add('show');
            const modal = document.getElementById('cityRequestModal');
            modal.classList.add('show');
            modal.setAttribute('aria-hidden', 'false');
            // Reset form
            document.getElementById('cityRequestForm').reset();
            document.getElementById('cityRequestSuccess').style.display = 'none';
        }

        function closeCityRequest() {
            document.getElementById('cityRequestOverlay').classList.remove('show');
            const modal = document.getElementById('cityRequestModal');
            modal.classList.remove('show');
            modal.setAttribute('aria-hidden', 'true');
        }

        function openDonation() {
            document.getElementById('donationOverlay').classList.add('show');
            const modal = document.getElementById('donationModal');
            modal.classList.add('show');
            modal.setAttribute('aria-hidden', 'false');
        }

        function closeDonation() {
            document.getElementById('donationOverlay').classList.remove('show');
            const modal = document.getElementById('donationModal');
            modal.classList.remove('show');
            modal.setAttribute('aria-hidden', 'true');
        }
        
        // Handle city request form submission
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('cityRequestForm');
            if (form) {
                form.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    const name = document.getElementById('cityRequestName').value;
                    const email = document.getElementById('cityRequestEmail').value;
                    const city = document.getElementById('cityRequestCity').value;
                    
                    // Create mailto link with pre-filled content
                    const subject = encodeURIComponent('City Request: ' + city);
                    const body = encodeURIComponent(
                        `Hi Jeff,\n\n` +
                        `I'd like to request support for my city!\n\n` +
                        `Name: ${name}\n` +
                        `Email: ${email}\n` +
                        `City: ${city}\n\n` +
                        `Looking forward to hearing from you!\n\n` +
                        `Best,\n${name}`
                    );
                    
                    // Open email client
                    window.location.href = `mailto:jeff.brines@gmail.com?subject=${subject}&body=${body}`;
                    
                    // Show success message
                    document.getElementById('cityRequestSuccess').style.display = 'block';
                    form.style.display = 'none';
                });
            }
        });

        function openAbout() {
            document.getElementById('aboutOverlay').classList.add('show');
            const modal = document.getElementById('aboutModal');
            modal.classList.add('show');
            modal.setAttribute('aria-hidden', 'false');
        }

        function closeAbout() {
            document.getElementById('aboutOverlay').classList.remove('show');
            const modal = document.getElementById('aboutModal');
            modal.classList.remove('show');
            modal.setAttribute('aria-hidden', 'true');
        }

        function openLensInfo() {
            const lens = document.getElementById('lens')?.value || 'blended_0_10';
            const label = lensLabel(lens);
            const body = document.getElementById('lensBody');
            const highlight = (name) => (name === label ? `<span style="background:#eef2ff; border:1px solid #c7d2fe; padding:1px 6px; border-radius:999px; font-weight:800;">${name} (selected)</span>` : `<b>${name}</b>`);

            if (body) {
                body.innerHTML = `
                    <div style="margin-bottom:10px;">You‚Äôre currently using: ${highlight(label)}.</div>
                    <div style="margin-bottom:12px; padding:10px; background:#f0fdf4; border:1px solid #bbf7d0; border-radius:8px; font-size:0.9rem;">
                        <b>Percentile-based scoring:</b> All scores are relative rankings within our curated dataset of 251 Denver spots. 
                        A 9.5 means "top of our list" ‚Äî not perfect, but the best among authentic local places.
                    </div>
                    <ul>
                        <li>${highlight('Quality')}: "Is it good?" ‚Äî 35% food/drink quality + 30% recommendations + 15% service + 10% value + 10% memorable. Measures overall quality of experience.</li>
                        <li>${highlight('Character')}: "Has soul?" ‚Äî 30% authenticity + 25% classic/institution + 20% unpretentious + 15% divey + 10% memorable. Measures genuine character and vibe.</li>
                        <li>${highlight('Underrated')}: "Better than Google says?" ‚Äî 40% recommend-gap + 30% sentiment-gap + 30% discovery factor. Finds hidden gems undervalued by star ratings.</li>
                        <li>${highlight('Blended')}: Best overall ‚Äî 40% Quality + 35% Character + 25% Underrated. Balanced score for well-rounded places.</li>
                        <li>${highlight('Custom')}: Build your own lens by adjusting the 9 signal sliders to weight what matters to you.</li>
                    </ul>
                    <div class="meta" style="margin-top:10px;">Scores range from ~2 to ~9.5. Use the Minimum score slider to filter out lower-ranked places.</div>
                `;
            }

            document.getElementById('lensOverlay').classList.add('show');
            const modal = document.getElementById('lensModal');
            modal.classList.add('show');
            modal.setAttribute('aria-hidden', 'false');
        }

        function closeLensInfo() {
            document.getElementById('lensOverlay').classList.remove('show');
            const modal = document.getElementById('lensModal');
            modal.classList.remove('show');
            modal.setAttribute('aria-hidden', 'true');
        }

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeCityRequest();
                closeDonation();
                closeAbout();
                closeLensInfo();
                closeMobileMenu();
                closeDetails();
            }
        });

        // Custom Lens Functions
        let isCustomLensActive = false;

        function onLensChange() {
            const lens = document.getElementById('lens').value;
            const lensAdvanced = document.getElementById('lensAdvanced');
            const builder = document.getElementById('customLensBuilder');
            
            // Sync the advanced lens select
            if (lensAdvanced && lensAdvanced.value !== lens) {
                lensAdvanced.value = lens;
            }
            
            if (lens === 'custom') {
                builder.classList.add('show');
            } else {
                builder.classList.remove('show');
                isCustomLensActive = false;
                fetchLocations();
            }
        }

        function updateWeightDisplay(slider) {
            const value = slider.value;
            slider.nextElementSibling.textContent = value + '%';
        }

        function getCustomWeights() {
            const weights = {};
            const signals = [
                'food_drink_quality', 'service_quality', 'value_score',
                'divey_score', 'classic_institution', 'unpretentious',
                'authenticity', 'would_recommend', 'memorable'
            ];
            
            signals.forEach(sig => {
                const el = document.getElementById('w_' + sig);
                if (el) {
                    const val = parseInt(el.value, 10) / 100;
                    if (val > 0) weights[sig] = val;
                }
            });
            
            return weights;
        }

        async function applyCustomLens() {
            const weights = getCustomWeights();
            
            if (Object.keys(weights).length === 0) {
                alert('Please set at least one signal weight above 0%');
                return;
            }

            isCustomLensActive = true;
            const minRating = document.getElementById('minRating').value;
            const minReviews = document.getElementById('minReviews').value;
            const container = document.getElementById('results');
            container.innerHTML = '<div class="loading">Applying custom lens...</div>';

            try {
                const params = new URLSearchParams();
                params.set('weights', JSON.stringify(weights));
                params.set('min_rating', minRating);
                params.set('min_reviews', minReviews);

                const url = `${API_BASE_URL}/locations/custom?${params.toString()}`;
                const response = await fetch(url);
                
                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.detail || 'Failed to apply custom lens');
                }
                
                const locations = await response.json();
                
                const totalHeader = response.headers.get('X-Total-Count');
                const totalNum = totalHeader ? parseInt(totalHeader, 10) : NaN;
                lastTotalCount = Number.isFinite(totalNum) ? totalNum : null;

                // Map custom_score to blended_0_10 for display
                locations.forEach(loc => {
                    loc.blended_0_10 = loc.custom_score;
                });

                emptyStateMessage = null;
                lastLocations = Array.isArray(locations) ? locations : [];
                lastLens = 'blended_0_10'; // Use blended for display purposes
                renderLocations();

            } catch (error) {
                container.innerHTML = `<div style="text-align:center; color:red">${error.message}</div>`;
                console.error('Error:', error);
            }
        }

        function resetCustomLens() {
            const signals = [
                'food_drink_quality', 'service_quality', 'value_score',
                'divey_score', 'classic_institution', 'unpretentious',
                'authenticity', 'would_recommend', 'memorable'
            ];
            
            const defaults = {
                food_drink_quality: 50, service_quality: 30, value_score: 40,
                divey_score: 20, classic_institution: 30, unpretentious: 30,
                authenticity: 40, would_recommend: 50, memorable: 30
            };
            
            signals.forEach(sig => {
                const el = document.getElementById('w_' + sig);
                if (el) {
                    el.value = defaults[sig] || 50;
                    updateWeightDisplay(el);
                }
            });
        }

        // View Toggle (List vs Vibe Map)
        let currentView = 'list';
        let vibeMapChart = null;

        function switchView(view) {
            currentView = view;
            const listView = document.getElementById('results');
            const vibeView = document.getElementById('vibeMapContainer');
            const listBtn = document.getElementById('listViewBtn');
            const vibeBtn = document.getElementById('vibeMapBtn');

            if (view === 'list') {
                listView.classList.add('results-list');
                listView.style.display = '';
                vibeView.classList.remove('show');
                listBtn.classList.add('active');
                vibeBtn.classList.remove('active');
            } else {
                listView.style.display = 'none';
                vibeView.classList.add('show');
                listBtn.classList.remove('active');
                vibeBtn.classList.add('active');
                renderVibeMap();
            }
        }

        function renderVibeMap() {
            const canvas = document.getElementById('vibeMapChart');
            const ctx = canvas.getContext('2d');
            const lens = document.getElementById('lens').value;
            const minScore = getMinScore();

            // Filter locations same as list view
            const filtered = (lastLocations || []).filter(p => {
                if (minScore <= 0) return true;
                const s = p && typeof p[lens] === 'number' ? p[lens] : null;
                return (typeof s === 'number') && !Number.isNaN(s) && s >= minScore;
            });

            // Use Quality (X) vs Character (Y) for meaningful axes
            // Dynamic quadrants based on actual data distribution

            // Get all quality and character scores
            const qualities = filtered.map(p => typeof p.quality_0_10 === 'number' ? p.quality_0_10 : 5);
            const characters = filtered.map(p => typeof p.character_0_10 === 'number' ? p.character_0_10 : 5);
            const scores = filtered.map(p => p[lens] || p.blended_0_10 || 5);
            
            // Calculate medians for dynamic quadrant lines
            const sortedQ = [...qualities].sort((a, b) => a - b);
            const sortedC = [...characters].sort((a, b) => a - b);
            const sortedScores = [...scores].sort((a, b) => a - b);
            const medianQ = sortedQ[Math.floor(sortedQ.length / 2)] || 5;
            const medianC = sortedC[Math.floor(sortedC.length / 2)] || 5;
            
            // Calculate data bounds with padding (zoom out more to prevent label overlap)
            const minQ = Math.min(...qualities) - 1.0;
            const maxQ = Math.max(...qualities) + 1.0;
            const minC = Math.min(...characters) - 1.0;
            const maxC = Math.max(...characters) + 1.0;
            
            // Store for quadrant plugin
            window.vibeMapMedians = { q: medianQ, c: medianC };
            window.vibeMapBounds = { minQ, maxQ, minC, maxC };
            
            // Prepare data points with jitter to spread overlaps
            const jitterAmount = 0.15;
            const dataPoints = filtered.map((p, i) => {
                const score = scores[i];
                const quality = qualities[i];
                const character = characters[i];
                
                // Add small jitter to spread overlapping points
                const jitterX = (Math.random() - 0.5) * jitterAmount;
                const jitterY = (Math.random() - 0.5) * jitterAmount;
                
                // Rank-based sizing (percentile within current set)
                const rank = sortedScores.indexOf(score);
                const percentile = filtered.length > 1 ? rank / (filtered.length - 1) : 0.5;
                const bubbleSize = 4 + percentile * 8; // 4-12px range (smaller for less overlap)
                
                // Color by lens score
                let color;
                if (score >= 8) color = 'rgba(39, 174, 96, 0.7)';       // Green - gem
                else if (score >= 6) color = 'rgba(41, 128, 185, 0.7)'; // Blue - solid
                else color = 'rgba(149, 165, 166, 0.65)';               // Gray - meh

                return {
                    x: quality + jitterX,
                    y: character + jitterY,
                    r: bubbleSize,
                    backgroundColor: color,
                    borderColor: color.replace(/[\d.]+\)$/, '1)'),
                    place: p,
                    score: score
                };
            });

            // Destroy existing chart
            if (vibeMapChart) {
                vibeMapChart.destroy();
            }

            // Quadrant label and divider plugin (uses dynamic medians)
            const quadrantLabels = {
                id: 'quadrantLabels',
                beforeDatasetsDraw: (chart) => {
                    const { ctx, chartArea: { left, right, top, bottom }, scales: { x, y } } = chart;
                    const medians = window.vibeMapMedians || { q: 5, c: 5 };
                    
                    // Draw quadrant dividing lines at median values
                    const midX = x.getPixelForValue(medians.q);
                    const midY = y.getPixelForValue(medians.c);
                    
                    ctx.save();
                    ctx.strokeStyle = 'rgba(148, 163, 184, 0.4)';
                    ctx.lineWidth = 1;
                    ctx.setLineDash([4, 4]);
                    
                    // Vertical line
                    ctx.beginPath();
                    ctx.moveTo(midX, top);
                    ctx.lineTo(midX, bottom);
                    ctx.stroke();
                    
                    // Horizontal line
                    ctx.beginPath();
                    ctx.moveTo(left, midY);
                    ctx.lineTo(right, midY);
                    ctx.stroke();
                    
                    ctx.restore();
                },
                afterDraw: (chart) => {
                    const { ctx, chartArea: { left, right, top, bottom }, scales: { x, y } } = chart;
                    const medians = window.vibeMapMedians || { q: 5, c: 5 };
                    const midX = x.getPixelForValue(medians.q);
                    const midY = y.getPixelForValue(medians.c);
                    
                    ctx.save();
                    ctx.font = '10px system-ui, sans-serif';
                    ctx.fillStyle = 'rgba(100, 116, 139, 0.6)';
                    ctx.textAlign = 'center';
                    
                    // Top-right: Hidden Gems (above median on both) - positioned further from edge
                    ctx.fillText('üåü Best Finds', (midX + right) / 2, top + 5);
                    // Top-left: Character over Quality
                    ctx.fillText('üç∫ Character', (left + midX) / 2, top + 5);
                    // Bottom-right: Quality over Character
                    ctx.fillText('‚ú® Quality', (midX + right) / 2, bottom - 18);
                    // Bottom-left: Below median on both
                    ctx.fillText('üìç Average', (left + midX) / 2, bottom - 18);
                    
                    ctx.restore();
                }
            };

            // Create scatter chart
            vibeMapChart = new Chart(ctx, {
                type: 'bubble',
                plugins: [quadrantLabels],
                data: {
                    datasets: [{
                        label: 'Places',
                        data: dataPoints,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    layout: {
                        padding: { top: 20, bottom: 25, left: 10, right: 10 }
                    },
                    plugins: {
                        legend: { display: false },
                        zoom: {
                            zoom: {
                                wheel: { enabled: true, modifierKey: null },
                                pinch: { enabled: true },
                                mode: 'xy'
                            },
                            pan: {
                                enabled: true,
                                mode: 'xy',
                                modifierKey: 'shift'
                            }
                        },
                        tooltip: {
                            callbacks: {
                                title: function(context) {
                                    return context[0].raw.place.name;
                                },
                                label: function(context) {
                                    const p = context.raw.place;
                                    const q = p.quality_0_10 ? p.quality_0_10.toFixed(1) : '?';
                                    const c = p.character_0_10 ? p.character_0_10.toFixed(1) : '?';
                                    return `Quality: ${q} ‚Ä¢ Character: ${c}`;
                                },
                                afterLabel: function(context) {
                                    const score = context.raw.score;
                                    return `${lensLabel(lens)}: ${score.toFixed(1)}`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            display: true,
                            min: window.vibeMapBounds?.minQ ?? 4,
                            max: window.vibeMapBounds?.maxQ ?? 10,
                            title: { display: true, text: '‚Üê Lower Quality    |    Higher Quality ‚Üí', color: '#64748b', font: { size: 11, weight: '600' } },
                            grid: { color: 'rgba(0,0,0,0.06)' },
                            ticks: { display: true, color: '#94a3b8' }
                        },
                        y: {
                            display: true,
                            min: window.vibeMapBounds?.minC ?? 4,
                            max: window.vibeMapBounds?.maxC ?? 10,
                            title: { display: true, text: '‚Üê Less Character    |    More Character ‚Üí', color: '#64748b', font: { size: 11, weight: '600' } },
                            grid: { color: 'rgba(0,0,0,0.06)' },
                            ticks: { display: true, color: '#94a3b8' }
                        }
                    },
                    onClick: function(event, elements) {
                        if (elements.length > 0) {
                            const idx = elements[0].index;
                            const place = dataPoints[idx].place;
                            
                            // On mobile, show quick preview first
                            if (window.innerWidth <= 768) {
                                showVibePreview(place);
                            } else {
                                // Desktop: open full details directly
                                openDetails(place);
                                // Also highlight on map
                                if (place.lat && place.lng) {
                                    map.flyTo([place.lat, place.lng], 16);
                                    const marker = markerByPlaceId[place.place_id];
                                    if (marker) marker.openPopup();
                                }
                            }
                        }
                    }
                }
            });

            // Remove any existing notice (we now show status in axis labels)
            const container = document.getElementById('vibeMapContainer');
            const notice = container.querySelector('.umap-notice');
            if (notice) notice.remove();
        }

        function resetVibeMapZoom() {
            if (vibeMapChart) {
                vibeMapChart.resetZoom();
            }
        }

        // Mobile Vibe Map Quick Preview
        let vibePreviewPlace = null;

        function showVibePreview(place) {
            vibePreviewPlace = place;
            document.getElementById('vibePreviewName').textContent = place.name || 'Unknown';
            document.getElementById('vibePreviewQuality').textContent = 
                typeof place.quality_0_10 === 'number' ? place.quality_0_10.toFixed(1) : '--';
            document.getElementById('vibePreviewCharacter').textContent = 
                typeof place.character_0_10 === 'number' ? place.character_0_10.toFixed(1) : '--';
            document.getElementById('vibePreviewBlended').textContent = 
                typeof place.blended_0_10 === 'number' ? place.blended_0_10.toFixed(1) : '--';
            
            document.getElementById('vibePreviewOverlay').classList.add('show');
            document.getElementById('vibePreview').classList.add('show');
        }

        function closeVibePreview() {
            document.getElementById('vibePreviewOverlay').classList.remove('show');
            document.getElementById('vibePreview').classList.remove('show');
            vibePreviewPlace = null;
        }

        function openVibePreviewDetails() {
            if (!vibePreviewPlace) return;
            const place = vibePreviewPlace;
            closeVibePreview();
            openDetails(place);
            // Also highlight on map
            if (place.lat && place.lng) {
                map.flyTo([place.lat, place.lng], 16);
                const marker = markerByPlaceId[place.place_id];
                if (marker) marker.openPopup();
            }
        }

        // Mobile Map Floating Filter Bar
        function toggleMobileMapFilters() {
            const panel = document.getElementById('mobileMapFiltersPanel');
            const isOpen = panel.classList.toggle('show');
            document.getElementById('mobileMapFiltersLabel').textContent = isOpen ? 'Close' : 'Filters';
        }

        function syncMobileMinScore() {
            const val = parseFloat(document.getElementById('mobileMinScore').value);
            document.getElementById('mobileMinScoreValue').textContent = val.toFixed(1);
        }

        function applyMobileFilters() {
            // Sync mobile slider value to main slider
            const mobileVal = parseFloat(document.getElementById('mobileMinScore').value);
            document.getElementById('minLensScore').value = mobileVal;
            document.getElementById('minLensScoreValue').textContent = mobileVal.toFixed(1);
            
            // Re-render locations with new filter
            renderLocations();
            
            // Close the filter panel
            document.getElementById('mobileMapFiltersPanel').classList.remove('show');
            document.getElementById('mobileMapFiltersLabel').textContent = 'Filters';
        }

        function showMobileMapFilters() {
            // Sync the mobile slider with the main slider value
            const mainVal = parseFloat(document.getElementById('minLensScore').value) || 0;
            document.getElementById('mobileMinScore').value = mainVal;
            document.getElementById('mobileMinScoreValue').textContent = mainVal.toFixed(1);
            document.getElementById('mobileMapFilters').classList.add('show');
        }

        function hideMobileMapFilters() {
            document.getElementById('mobileMapFilters').classList.remove('show');
            document.getElementById('mobileMapFiltersPanel').classList.remove('show');
            document.getElementById('mobileMapFiltersLabel').textContent = 'Filters';
        }

        // Mobile Menu Functions
        function toggleMobileMenu() {
            const menu = document.getElementById('mobileMenu');
            const overlay = document.getElementById('mobileMenuOverlay');
            const isOpen = menu.classList.toggle('show');
            overlay.classList.toggle('show', isOpen);
        }

        function closeMobileMenu() {
            document.getElementById('mobileMenu').classList.remove('show');
            document.getElementById('mobileMenuOverlay').classList.remove('show');
        }

        // Mobile Tab Switching (List/Vibe/Map)
        let currentMobileTab = 'list';

        function switchMobileTab(tab) {
            currentMobileTab = tab;
            const sidebar = document.querySelector('.sidebar');
            const mapEl = document.getElementById('map');
            const listTab = document.getElementById('mobileListTab');
            const vibeTab = document.getElementById('mobileVibeTab');
            const mapTab = document.getElementById('mobileMapTab');

            // Reset all tabs
            [listTab, vibeTab, mapTab].forEach(t => {
                if (t) {
                    t.classList.remove('active');
                    t.setAttribute('aria-selected', 'false');
                }
            });

            if (tab === 'list') {
                sidebar.classList.remove('mobile-hidden');
                mapEl.classList.add('mobile-hidden');
                listTab.classList.add('active');
                listTab.setAttribute('aria-selected', 'true');
                // Switch to list view in sidebar
                switchView('list');
                hideMobileMapFilters();
            } else if (tab === 'vibe') {
                sidebar.classList.remove('mobile-hidden');
                mapEl.classList.add('mobile-hidden');
                vibeTab.classList.add('active');
                vibeTab.setAttribute('aria-selected', 'true');
                // Switch to vibe map view in sidebar
                switchView('vibe');
                hideMobileMapFilters();
            } else {
                sidebar.classList.add('mobile-hidden');
                mapEl.classList.remove('mobile-hidden');
                mapTab.classList.add('active');
                mapTab.setAttribute('aria-selected', 'true');
                // Invalidate map size when shown (fixes rendering issues)
                setTimeout(() => map.invalidateSize(), 100);
                // Show floating filter bar on map view
                showMobileMapFilters();
            }
        }

        // Sync lens selects (main and advanced)
        function syncLens(source) {
            const main = document.getElementById('lens');
            const advanced = document.getElementById('lensAdvanced');
            if (source === 'advanced' && advanced && main) {
                main.value = advanced.value;
            } else if (main && advanced) {
                advanced.value = main.value;
            }
            onLensChange();
        }

        // Sync type filter selects (main and advanced)
        function syncTypeFilter(source) {
            const main = document.getElementById('typeFilter');
            const advanced = document.getElementById('typeFilterAdvanced');
            if (source === 'advanced' && advanced && main) {
                main.value = advanced.value;
            } else if (main && advanced) {
                advanced.value = main.value;
            }
        }

        // Handle window resize - reset mobile state when going to desktop
        function handleResize() {
            const isMobile = window.innerWidth <= 768;
            const sidebar = document.querySelector('.sidebar');
            const mapEl = document.getElementById('map');
            const mobileAdvanced = document.querySelectorAll('.control-group.mobile-advanced');
            
            if (!isMobile) {
                // Desktop: ensure both are visible, show desktop-only controls
                sidebar.classList.remove('mobile-hidden');
                mapEl.classList.remove('mobile-hidden');
                closeMobileMenu();
                hideMobileMapFilters();
                // Show desktop controls (Lens, Type)
                mobileAdvanced.forEach(el => el.style.display = '');
            } else {
                // Mobile: apply current tab state, hide controls unless More Filters is open
                switchMobileTab(currentMobileTab);
                const advancedOpen = document.getElementById('advancedFilters').classList.contains('show');
                mobileAdvanced.forEach(el => {
                    el.style.display = advancedOpen ? 'flex' : 'none';
                });
            }
        }

        window.addEventListener('resize', handleResize);

        // Initialize mobile state on page load
        function initMobileState() {
            if (window.innerWidth <= 768) {
                switchMobileTab('list');
                // Hide mobile-advanced controls initially
                document.querySelectorAll('.control-group.mobile-advanced').forEach(el => {
                    el.style.display = 'none';
                });
            }
        }

        // Boot up
        initMap();
        onMinScoreChanged();
        fetchLocations();
        initMobileState();
    </script>
</body>
</html>
